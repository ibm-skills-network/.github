on:
  workflow_call:
    inputs:
      repo_name:
        required: true
        type: string
    secrets:
      ssh_private_key:
        required: true
      ghe_token:
        required: false

jobs:
  mirror:
    name: mirror
    runs-on: ubuntu-latest
    env:
      GH_HOST: github.ibm.com
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check if target mirror repository exists
      continue-on-error: true
      id: check_repo
      run: |
        gh repo view $GH_HOST/skills-network-mirror/${{ inputs.repo_name }} > /dev/null
      env:
        GH_ENTERPRISE_TOKEN: ${{ secrets.ghe_token }}

    - name: Check if token was provided
      if: ${{ steps.check_repo.outcome == 'failure'}}
      run: |
        if [ -z "${{ secrets.ghe_token }}" ]; then
          echo "GHE token not provided"
          exit 1
        fi

    - name: Create repository if it does not exist
      if: ${{ steps.check_repo.outcome == 'failure'}}
      run: |
        gh repo create $GH_HOST/skills-network-mirror/${{ inputs.repo_name }} --internal
      env:
        GH_ENTERPRISE_TOKEN: ${{ secrets.ghe_token }}

    - name: Mirror repository
      uses: pixta-dev/repository-mirroring-action@v1
      with:
        target_repo_url:
          ${{ format('git@github.ibm.com:{0}/{1}.git', 'skills-network-mirror', inputs.repo_name) }}
        ssh_private_key:
          ${{ secrets.ssh_private_key }}

    - run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.ssh_private_key }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        export GIT_SSH_COMMAND="ssh -v -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o IdentitiesOnly=yes"
        git config --global user.email "mirror@skills.network"
        git config --global user.name "Skills Network Mirror"

        mkdir -p ../fixmirror
        cd ../fixmirror
        git clone "${{ format('git@github.ibm.com:{0}/{1}.git', 'skills-network-mirror', inputs.repo_name) }}"
        cd "${{ inputs.repo_name }}"

        echo "base64 decoding .whitesource file..."

        openssl base64 -d <<<   'ewogICJzY2FuU2V0dGluZ3MiOiB7CiAgICAiY29uZmlnTW9kZSI6ICJMT0NBTCIsCiAgICAiY29uZmlnRXh0ZXJuYWxVUkwiOiAiIiwKICAgICJwcm9qZWN0VG9rZW4iOiAiIiwKICAgICJiYXNlQnJhbmNoZXMiOiBbXQogIH0sCiAgImNoZWNrUnVuU2V0dGluZ3MiOiB7CiAgICAidnVsbmVyYWJsZUNoZWNrUnVuQ29uY2x1c2lvbkxldmVsIjogImZhaWx1cmUiLAogICAgImRpc3BsYXlNb2RlIjogImRpZmYiCiAgfSwKICAiaXNzdWVTZXR0aW5ncyI6IHsKICAgICJtaW5TZXZlcml0eUxldmVsIjogIkxPVyIKICB9LAogICJyZW1lZGlhdGVTZXR0aW5ncyI6IHsKICAgICJlbmFibGVSZW5vdmF0ZSI6IHRydWUsCiAgICAidHJhbnNpdGl2ZVJlbWVkaWF0aW9uIjogZmFsc2UKICB9Cn0KCg==' 
        openssl base64 -d <<<   'ewogICJzY2FuU2V0dGluZ3MiOiB7CiAgICAiY29uZmlnTW9kZSI6ICJMT0NBTCIsCiAgICAiY29uZmlnRXh0ZXJuYWxVUkwiOiAiIiwKICAgICJwcm9qZWN0VG9rZW4iOiAiIiwKICAgICJiYXNlQnJhbmNoZXMiOiBbXQogIH0sCiAgImNoZWNrUnVuU2V0dGluZ3MiOiB7CiAgICAidnVsbmVyYWJsZUNoZWNrUnVuQ29uY2x1c2lvbkxldmVsIjogImZhaWx1cmUiLAogICAgImRpc3BsYXlNb2RlIjogImRpZmYiCiAgfSwKICAiaXNzdWVTZXR0aW5ncyI6IHsKICAgICJtaW5TZXZlcml0eUxldmVsIjogIkxPVyIKICB9LAogICJyZW1lZGlhdGVTZXR0aW5ncyI6IHsKICAgICJlbmFibGVSZW5vdmF0ZSI6IHRydWUsCiAgICAidHJhbnNpdGl2ZVJlbWVkaWF0aW9uIjogZmFsc2UKICB9Cn0KCg==' > .whitesource
        
        echo "base64 decoding whitesource.config file..."
        openssl base64 -d <<<   'bnBtLmluY2x1ZGVEZXZEZXBlbmRlbmNpZXM9ZmFsc2UKYnVuZGxlci5pZ25vcmVTb3VyY2VGaWxlcz10cnVlCmJ1bmRsZXIucnVuUHJlU3RlcD1mYWxzZQoiZXhjbHVkZSI6IFsKICAiKiovR2VtZmlsZS5sb2NrOmdyb3VwOmRldmVsb3BtZW50IiwKICAiKiovR2VtZmlsZS5sb2NrOmdyb3VwOnRlc3QiCl0K' 
        openssl base64 -d <<<   'bnBtLmluY2x1ZGVEZXZEZXBlbmRlbmNpZXM9ZmFsc2UKYnVuZGxlci5pZ25vcmVTb3VyY2VGaWxlcz10cnVlCmJ1bmRsZXIucnVuUHJlU3RlcD1mYWxzZQoiZXhjbHVkZSI6IFsKICAiKiovR2VtZmlsZS5sb2NrOmdyb3VwOmRldmVsb3BtZW50IiwKICAiKiovR2VtZmlsZS5sb2NrOmdyb3VwOnRlc3QiCl0K' > whitesource.config

        git add .whitesource whitesource.config
        git commit -m "use GHE .whitesource and whitesource.config"
        git push
